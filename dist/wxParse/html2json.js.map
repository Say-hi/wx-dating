{"version":3,"sources":["wxParse/html2json.js"],"names":["__placeImgeUrlHttps","__emojisReg","__emojisBaseSrc","__emojis","wxDiscode","require","HTMLParser","empty","makeMap","block","inline","closeSelf","fillAttrs","special","str","obj","items","split","i","length","q","v","removeDOCTYPE","html","replace","html2json","bindName","strDiscode","bufArray","results","node","nodes","images","imageUrls","start","tag","attrs","unary","tagType","attr","reduce","pre","name","value","classStr","styleStr","match","Array","isArray","push","imgIndex","imgUrl","src","urlToHttpUrl","from","fontSize","styleAttrs","style","key","source","parent","undefined","unshift","end","shift","console","error","result","chars","text","textArray","transEmojiStr","comment","emojiObjs","emojiObj","array","eReg","RegExp","ele","baseSrc","emojisInit","reg","emojis","module","exports"],"mappings":"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","file":"html2json.js","sourcesContent":["/**\n * html2Json 改造来自: https://github.com/Jxck/html2json\n * author: Di (微信小程序开发工程师)\n * organization: WeAppDev(微信小程序开发论坛)(http://weappdev.com)\n *               垂直微信小程序开发交流社区\n * github地址: https://github.com/icindy/wxParse\n * for: 微信小程序富文本解析\n * detail : http://weappdev.com/t/wxparse-alpha0-1-html-markdown/184\n */\n/*eslint-disable */\nvar __placeImgeUrlHttps = \"https\";\nvar __emojisReg = '';\nvar __emojisBaseSrc = '';\nvar __emojis = {};\nvar wxDiscode = require('./wxDiscode.js');\nvar HTMLParser = require('./htmlparser.js');\n// Empty Elements - HTML 5\nvar empty = makeMap(\"area,base,basefont,br,col,frame,hr,img,input,link,meta,param,embed,command,keygen,source,track,wbr\");\n// Block Elements - HTML 5\nvar block = makeMap(\"br,a,code,address,article,applet,aside,audio,blockquote,button,canvas,center,dd,del,dir,div,dl,dt,fieldset,figcaption,figure,footer,form,frameset,h1,h2,h3,h4,h5,h6,header,hgroup,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,output,p,pre,section,script,table,tbody,td,tfoot,th,thead,tr,ul,video\");\n\n// Inline Elements - HTML 5\nvar inline = makeMap(\"abbr,acronym,applet,b,basefont,bdo,big,button,cite,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var\");\n\n// Elements that you can, intentionally, leave open\n// (and which close themselves)\nvar closeSelf = makeMap(\"colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr\");\n\n// Attributes that have their values filled in disabled=\"disabled\"\nvar fillAttrs = makeMap(\"checked,compact,declare,defer,disabled,ismap,multiple,nohref,noresize,noshade,nowrap,readonly,selected\");\n\n// Special Elements (can contain anything)\nvar special = makeMap(\"wxxxcode-style,script,style,view,scroll-view,block\");\nfunction makeMap(str) {\n    var obj = {}, items = str.split(\",\");\n    for (var i = 0; i < items.length; i++)\n        obj[items[i]] = true;\n    return obj;\n}\n\nfunction q(v) {\n    return '\"' + v + '\"';\n}\n\nfunction removeDOCTYPE(html) {\n    return html\n        .replace(/<\\?xml.*\\?>\\n/, '')\n        .replace(/<.*!doctype.*\\>\\n/, '')\n        .replace(/<.*!DOCTYPE.*\\>\\n/, '');\n}\n\n\nfunction html2json(html, bindName) {\n    //处理字符串\n    html = removeDOCTYPE(html);\n    html = wxDiscode.strDiscode(html);\n    //生成node节点\n    var bufArray = [];\n    var results = {\n        node: bindName,\n        nodes: [],\n        images:[],\n        imageUrls:[]\n    };\n    HTMLParser(html, {\n        start: function (tag, attrs, unary) {\n            //debug(tag, attrs, unary);\n            // node for this element\n            var node = {\n                node: 'element',\n                tag: tag,\n            };\n\n            if (block[tag]) {\n                node.tagType = \"block\";\n            } else if (inline[tag]) {\n                node.tagType = \"inline\";\n            } else if (closeSelf[tag]) {\n                node.tagType = \"closeSelf\";\n            }\n\n            if (attrs.length !== 0) {\n                node.attr = attrs.reduce(function (pre, attr) {\n                    var name = attr.name;\n                    var value = attr.value;\n                    if (name == 'class') {\n                        // console.dir(value);\n                        //  value = value.join(\"\")\n                        node.classStr = value;\n                    }\n                    // has multi attibutes\n                    // make it array of attribute\n                    if (name == 'style') {\n                        // console.dir(value);\n                        //  value = value.join(\"\")\n                        node.styleStr = value;\n                    }\n                    if (value.match(/ /)) {\n                        value = value.split(' ');\n                    }\n                    \n\n                    // if attr already exists\n                    // merge it\n                    if (pre[name]) {\n                        if (Array.isArray(pre[name])) {\n                            // already array, push to last\n                            pre[name].push(value);\n                        } else {\n                            // single value, make it array\n                            pre[name] = [pre[name], value];\n                        }\n                    } else {\n                        // not exist, put it\n                        pre[name] = value;\n                    }\n\n                    return pre;\n                }, {});\n            }\n\n            //对img添加额外数据\n            if (node.tag === 'img') {\n                node.imgIndex = results.images.length;\n                var imgUrl = node.attr.src;\n                imgUrl = wxDiscode.urlToHttpUrl(imgUrl, __placeImgeUrlHttps);\n                node.attr.src = imgUrl;\n                node.from = bindName;\n                results.images.push(node);\n                results.imageUrls.push(imgUrl);\n            }\n            \n            // 处理font标签样式属性\n            if (node.tag === 'font') {\n                var fontSize = ['x-small', 'small', 'medium', 'large', 'x-large', 'xx-large', '-webkit-xxx-large'];\n                var styleAttrs = {\n                    'color': 'color',\n                    'face': 'font-family',\n                    'size': 'font-size'\n                };\n                if (!node.attr.style) node.attr.style = [];\n                if (!node.styleStr) node.styleStr = '';\n                for (var key in styleAttrs) {\n                    if (node.attr[key]) {\n                        var value = key === 'size' ? fontSize[node.attr[key]-1] : node.attr[key];\n                        node.attr.style.push(styleAttrs[key]);\n                        node.attr.style.push(value);\n                        node.styleStr += styleAttrs[key] + ': ' + value + ';';\n                    }\n                }\n            }\n\n            //临时记录source资源\n            if(node.tag === 'source'){\n                results.source = node.attr.src;\n            }\n            \n            if (unary) {\n                // if this tag dosen't have end tag\n                // like <img src=\"hoge.png\"/>\n                // add to parents\n                var parent = bufArray[0] || results;\n                if (parent.nodes === undefined) {\n                    parent.nodes = [];\n                }\n                parent.nodes.push(node);\n            } else {\n                bufArray.unshift(node);\n            }\n        },\n        end: function (tag) {\n            //debug(tag);\n            // merge into parent tag\n            var node = bufArray.shift();\n            if (node.tag !== tag) console.error('invalid state: mismatch end tag');\n\n            //当有缓存source资源时于于video补上src资源\n            if(node.tag === 'video' && results.source){\n                node.attr.src = results.source;\n                delete result.source;\n            }\n            \n            if (bufArray.length === 0) {\n                results.nodes.push(node);\n            } else {\n                var parent = bufArray[0];\n                if (parent.nodes === undefined) {\n                    parent.nodes = [];\n                }\n                parent.nodes.push(node);\n            }\n        },\n        chars: function (text) {\n            //debug(text);\n            var node = {\n                node: 'text',\n                text: text,\n                textArray:transEmojiStr(text)\n            };\n            \n            if (bufArray.length === 0) {\n                results.nodes.push(node);\n            } else {\n                var parent = bufArray[0];\n                if (parent.nodes === undefined) {\n                    parent.nodes = [];\n                }\n                parent.nodes.push(node);\n            }\n        },\n        comment: function (text) {\n            //debug(text);\n            // var node = {\n            //     node: 'comment',\n            //     text: text,\n            // };\n            // var parent = bufArray[0];\n            // if (parent.nodes === undefined) {\n            //     parent.nodes = [];\n            // }\n            // parent.nodes.push(node);\n        },\n    });\n    return results;\n};\n\nfunction transEmojiStr(str){\n  // var eReg = new RegExp(\"[\"+__reg+' '+\"]\");\n//   str = str.replace(/\\[([^\\[\\]]+)\\]/g,':$1:')\n  \n  var emojiObjs = [];\n  //如果正则表达式为空\n  if(__emojisReg.length == 0 || !__emojis){\n      var emojiObj = {}\n      emojiObj.node = \"text\";\n      emojiObj.text = str;\n      array = [emojiObj];\n      return array;\n  }\n  //这个地方需要调整\n  str = str.replace(/\\[([^\\[\\]]+)\\]/g,':$1:')\n  var eReg = new RegExp(\"[:]\");\n  var array = str.split(eReg);\n  for(var i = 0; i < array.length; i++){\n    var ele = array[i];\n    var emojiObj = {};\n    if(__emojis[ele]){\n      emojiObj.node = \"element\";\n      emojiObj.tag = \"emoji\";\n      emojiObj.text = __emojis[ele];\n      emojiObj.baseSrc= __emojisBaseSrc;\n    }else{\n      emojiObj.node = \"text\";\n      emojiObj.text = ele;\n    }\n    emojiObjs.push(emojiObj);\n  }\n  \n  return emojiObjs;\n}\n\nfunction emojisInit(reg='',baseSrc=\"/wxParse/emojis/\",emojis){\n    __emojisReg = reg;\n    __emojisBaseSrc=baseSrc;\n    __emojis=emojis;\n}\n\nmodule.exports = {\n    html2json: html2json,\n    emojisInit:emojisInit\n};\n/*eslint-enable */\n"]}