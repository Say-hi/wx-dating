{"version":3,"sources":["pages/userOrder/userOrder.js"],"names":["app","getApp","useUrl","require","Page","data","title","orderMask","topTab","tabCurrent","page","orderMine","closeMoneyMask","setData","getUserMoney","that","gum","url","payIndex","session_key","wx","getStorageSync","success","res","code","coin","showToast","message","wxrequest","cancelCheck","e","status","currentTarget","dataset","orderId","id","setIndex","index","pay","setTimeout","goDetail","navigateTo","ta","showLoading","hideLoading","goPay","payMoney","payObj","payByOrder","order_id","console","log","length","timeStamp","nonceStr","package","paySign","errMsg","getInfo","fail","wxpay","chooseTab","type","obj","concat","myOrderListsByFaqi","benrenYingyaoOrderLists","titafaqiOrderList","onLoad","params","arr","wxlogin","onReady","onShow","hide","onHide","onUnload","onPullDownRefresh","onReachBottom"],"mappings":"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","file":"userOrder.js","sourcesContent":["// 获取全局应用程序实例对象\nconst app = getApp()\nconst useUrl = require('../../utils/service')\n// 创建页面实例对象\nPage({\n  /**\n   * 页面的初始数据\n   */\n  data: {\n    title: 'userOrder',\n    orderMask: false,\n    topTab: ['本人发起', '本人应邀', '替Ta发起'],\n    tabCurrent: 0,\n    page: 1,\n    orderMine: []\n  },\n  closeMoneyMask () {\n    this.setData({\n      orderMask: false\n    })\n  },\n  // 获取用户金额情况\n  getUserMoney () {\n    let that = this\n    let gum = {\n      url: useUrl.payIndex,\n      data: {\n        session_key: wx.getStorageSync('session_key')\n      },\n      success (res) {\n        if (res.data.code === 200) {\n          that.setData({\n            coin: res.data.data.coin || 0\n          })\n        } else {\n          wx.showToast({\n            title: res.data.message\n          })\n        }\n      }\n    }\n    app.wxrequest(gum)\n  },\n  // 取消赴约&&查看应邀\n  cancelCheck (e) {\n    // let index = e.currentTarget.dataset.index\n    let status = e.currentTarget.dataset.status * 1\n    let orderId = e.currentTarget.dataset.id\n    let tabCurrent = this.data.tabCurrent\n    this.setData({\n      setIndex: e.currentTarget.dataset.index\n    })\n    // console.log(orderId)\n    // console.log(status)\n    // console.log(tabCurrent)\n    if (status === 0 && tabCurrent === 0) {\n      // todo 查看应邀\n      if (e.currentTarget.dataset.pay * 1 === 1) {\n        wx.showToast({\n          title: '您未完成支付，请继续支付订单 '\n        })\n        setTimeout(() => {\n          this.goDetail(e)\n        }, 1000)\n        return\n      }\n      wx.navigateTo({\n        // url: '../checkInvited/checkInvited?orderId=' + orderId +\n        url: `../checkInvited/checkInvited?orderId=${orderId}&ta=${e.currentTarget.dataset.ta}`\n      })\n    } else if ((status === 1 || status === 4) && tabCurrent !== 2) {\n      // todo 取消赴约\n      wx.navigateTo({\n        url: '../cancelOrder/cancelOrder?id=' + orderId + '&status=' + status\n      })\n    } else if (status === 0 && tabCurrent === 2) {\n      // todo 提醒功能\n    } else if (status === 0 && tabCurrent === 1) {\n      // todo 微信支付\n      // console.log(1)\n      wx.showLoading({\n        title: '正在请求支付中...'\n      })\n      setTimeout(() => {\n        wx.hideLoading()\n        this.getUserMoney()\n        this.setData({\n          orderMask: true,\n          orderId: orderId\n        })\n      }, 300)\n    }\n  },\n  goPay () {\n    this.payMoney(this.data.orderId)\n  },\n  // 支付操作\n  payMoney (id) {\n    let that = this\n    let payObj = {\n      url: useUrl.payByOrder,\n      data: {\n        session_key: wx.getStorageSync('session_key'),\n        order_id: id\n      },\n      success (res) {\n        console.log(res)\n        // todo 微信支付流程\n        if (res.data.data.length !== 0) {\n          // app.wxpay(res.data.data)\n          let e = res.data.data\n          let payObj = {\n            timeStamp: e.timeStamp,\n            nonceStr: e.nonceStr,\n            package: e.package,\n            paySign: e.paySign,\n            success (res) {\n              // 支付成功响应\n              console.log('支付情况', res)\n              if (res.errMsg === 'requestPayment:ok') {\n                wx.showToast({\n                  title: '支付成功，订单已确认'\n                  // mask: true\n                })\n                that.setData({\n                  page: 1,\n                  orderMine: [],\n                  orderMask: false\n                })\n                that.getInfo(that.data.tabCurrent, 1)\n                // setTimeout(function () {\n                //   wx.redirectTo({\n                //     url: '../userOrder/userOrder'\n                //   })\n                // }, 1000)\n              }\n            },\n            fail (res) {\n              console.log('支付失败', res)\n            }\n          }\n          app.wxpay(payObj)\n        } else {\n          // 余额支付成功\n          that.setData({\n            orderMask: false\n          })\n          wx.showToast({\n            title: '支付成功，订单已确认'\n            // mask: true\n          })\n          that.setData({\n            page: 1,\n            orderMine: [],\n            orderMask: false\n          })\n          that.getInfo(that.data.tabCurrent, 1)\n        }\n      }\n    }\n    app.wxrequest(payObj)\n  },\n  // 顶部tab选择\n  chooseTab (e) {\n    this.setData({\n      orderMine: [],\n      tabCurrent: e.currentTarget.dataset.index,\n      page: 1\n    })\n    this.getInfo(e.currentTarget.dataset.index, 1)\n  },\n  // 获取信息列表\n  getInfo (type, page) {\n    let that = this\n    let obj = {\n      data: {\n        session_key: wx.getStorageSync('session_key'),\n        page: page\n      },\n      success (res) {\n        // console.log(res.data.data)\n        if (res.data.data.length === 0) {\n          return wx.showToast({\n            title: '亲，没有更多内容啦~'\n            // mask: true\n          })\n        }\n        that.setData({\n          orderMine: that.data.orderMine.concat(res.data.data)\n        })\n        // console.log(res)\n      }\n    }\n    if (type === 0) {\n      obj['url'] = useUrl.myOrderListsByFaqi\n    } else if (type === 1) {\n      obj['url'] = useUrl.benrenYingyaoOrderLists\n    } else if (type === 2) {\n      obj['url'] = useUrl.titafaqiOrderList\n    }\n    app.wxrequest(obj)\n  },\n  // 去到详情页\n  goDetail (e) {\n    if (this.data.tabCurrent * 1 === 2) return\n    if (this.data.tabCurrent * 1 === 1 && e.currentTarget.dataset.status * 1 === 6) {\n      return wx.showToast({\n        title: '对方未确认您的应邀，无法查看信息'\n      })\n    } else if (e.currentTarget.dataset.status * 1 === 0 && this.data.tabCurrent * 1 === 1) {\n      e.currentTarget.dataset['pay'] = 1\n    }\n    // else if (e.currentTarget.dataset.status * 1 !== 0) {\n    //   e.currentTarget.dataset['pay'] = 2\n    // }\n    wx.navigateTo({\n      url: `../orderDatial/orderDatial?id=${e.currentTarget.dataset.id}&status=${e.currentTarget.dataset.status}&pay=${e.currentTarget.dataset.pay}`\n    })\n  },\n  /**\n   * 生命周期函数--监听页面加载\n   */\n  onLoad (params) {\n    if (params.type === 'weixin') {\n      let arr = [0, 1]\n      app.wxlogin(this.getInfo, ...arr)\n    }\n    if (params.type === 'ta') {\n      this.setData({\n        tabCurrent: 2\n      })\n      return this.getInfo(2, 1)\n    }\n    this.getInfo(0, 1)\n    // TODO: onLoad\n  },\n\n  /**\n   *\n   * 生命周期函数--监听页面初次渲染完成\n   */\n  onReady () {\n    // TODO: onReady\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow () {\n    // TODO: onShow\n    if (this.data.hide) {\n      this.setData({\n        page: 1,\n        orderMine: []\n      })\n      this.getInfo(this.data.tabCurrent, 1)\n    }\n  },\n\n  /**\n   * 生命周期函数--监听页面隐藏\n   */\n  onHide () {\n    this.setData({\n      hide: true\n    })\n    // TODO: onHide\n  },\n\n  /**\n   * 生命周期函数--监听页面卸载\n   */\n  onUnload () {\n    this.setData({\n      hide: false\n    })\n    // TODO: onUnload\n  },\n\n  /**\n   * 页面相关事件处理函数--监听用户下拉动作\n   */\n  onPullDownRefresh () {\n    // TODO: onPullDownRefresh\n  },\n  // 触底加载数据\n  onReachBottom () {\n    this.getInfo(this.data.tabCurrent, ++this.data.page)\n  }\n})\n"]}