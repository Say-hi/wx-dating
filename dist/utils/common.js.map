{"version":3,"sources":["utils/common.js"],"names":["scanCode","callbackSuccess","callbackFail","wx","success","res","fail","wxRequest","obj","request","module","exports","login","loginSuccess","console","log","loginFail","getUserInfo","getUserSuccess","getUserFail","showModal","title","content","showCancel","withCredentials","getSessionKey","requestInfo","url","useUrl","serviceUrl","method","data","header","err","errMsg","complete","sessionCheck","that","checkSession","mainLogin","_this","callback","callback2","callback3","loginObj","params","code","session_key","setStorageSync","obj2","userInfo","setData"],"mappings":"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","file":"common.js","sourcesContent":["/*eslint-disable*/\r\n/**\r\n * Created by JiangWenqiang on 2017/5/3.\r\n */\r\n/**\r\n * 扫描二维码\r\n * @param callbackSuccess\r\n * @param callbackFail\r\n */\r\nfunction scanCode (callbackSuccess, callbackFail) {\r\n  wx.scanCode({\r\n    success (res) {\r\n      callbackSuccess(res)\r\n    },\r\n    fail (res) {\r\n      callbackFail(res)\r\n    }\r\n  })\r\n}\r\n/**\r\n * 数据请求\r\n * @param obj\r\n */\r\nfunction wxRequest (obj) {\r\n  wx.request(obj)\r\n}\r\nmodule.exports = {\r\n  scanCode,\r\n  wxRequest\r\n}\r\n/**\r\n *  用户微信授权登陆\r\n */\r\nfunction login (obj) {\r\n  var loginSuccess = obj.success || function () {\r\n      console.log('未传入success回调函数')\r\n    }\r\n  var loginFail = obj.success || function () {\r\n      console.log('未传入fail回调函数')\r\n    }\r\n  wx.login({\r\n    success: function success (res) {\r\n      // console.log(res.code)\r\n      loginSuccess(res)\r\n    },\r\n    fail: function fail (res) {\r\n      loginFail(res)\r\n    }\r\n  })\r\n}\r\n\r\n/**\r\n * 获取用户微信信息\r\n * @param obj\r\n */\r\nfunction getUserInfo (obj) {\r\n  var getUserSuccess = obj.success || function () {\r\n      console.log('未传入success回调函数')\r\n    }\r\n  var getUserFail = obj.fail || function () {\r\n      wx.showModal({\r\n        title: '未提供权限',\r\n        content: '请删除小程序后重新打开并授权',\r\n        showCancel: false\r\n      })\r\n    }\r\n  wx.getUserInfo({\r\n    // 默认获取用户带加密数据的信息\r\n    withCredentials: obj.withCredentials || false,\r\n    success: function success (res) {\r\n      getUserSuccess(res)\r\n    },\r\n    fail: function fail (res) {\r\n      getUserFail(res)\r\n    }\r\n  })\r\n}\r\n\r\n/**\r\n * 服务器获取用户session_key\r\n */\r\nfunction getSessionKey(obj) {\r\n  this.requestInfo(obj)\r\n}\r\n\r\n/**\r\n * 向服务器请求信息\r\n */\r\nfunction requestInfo(obj) {\r\n  wx.request({\r\n    url: obj.url || useUrl.serviceUrl.login,\r\n    method: obj.method || 'POST',\r\n    data: obj.data || {},\r\n    header: {\r\n      'content-type': obj.header || 'application/x-www-form-urlencoded'\r\n    },\r\n    success: obj.success || function () {\r\n      console.log('未传入success回调函数')\r\n    },\r\n    fail: obj.fail || function (err) {\r\n      console.log('未传入fail回调函数,err:' + err.errMsg)\r\n    },\r\n    complete: obj.complete || function () {}\r\n  })\r\n}\r\n\r\n/**\r\n * 登陆态检查\r\n */\r\nfunction sessionCheck() {\r\n  var that = this\r\n  wx.checkSession({\r\n    success: function success() {\r\n      console.log('session有效')\r\n      // that.mainLogin()\r\n    },\r\n    fail: function fail() {\r\n      console.log('session失效')\r\n      that.mainLogin()\r\n    }\r\n  })\r\n}\r\n\r\n/**\r\n * 主登陆函数\r\n */\r\nfunction mainLogin(_this, callback, callback2, callback3) {\r\n  var that = this\r\n  var loginObj = {\r\n    success: function success(params) {\r\n      // 获取用户登陆code\r\n      // console.log(res)\r\n      // 获取用户的session_key\r\n      // console.log('mainLogin' + res.code)\r\n      var obj = {\r\n        url: useUrl.serviceUrl.login + '?code=' + params.code,\r\n        method: 'GET',\r\n        // data: {\r\n        //   code: res.code\r\n        // },\r\n        header: 'application/json',\r\n        success: function success(res) {\r\n          // console.log(useUrl.serviceUrl.login + '?code=' + params.code)\r\n          // console.log(res)\r\n          // console.log(res.data.data.session_key)\r\n          // session_key 存储\r\n          that.data.session_key = res.data.data.session_key;\r\n          wx.setStorageSync('session_key', res.data.data.session_key);\r\n          if (callback) {\r\n            callback()\r\n          }\r\n          if (callback2) {\r\n            callback2()\r\n          }\r\n          if (callback3) {\r\n            callback3()\r\n          }\r\n        },\r\n        fail: function fail(res) {\r\n          console.log(res)\r\n        }\r\n      }\r\n      that.getSessionKey(obj)\r\n      // 获取用户信息\r\n      var obj2 = {\r\n        success: function success(res) {\r\n          // console.log(res)\r\n          that.data.userInfo = res.userInfo\r\n          wx.setStorageSync('userInfo', res.userInfo)\r\n          if (_this) {\r\n            _this.setData({\r\n              userInfo: res.userInfo\r\n            })\r\n          }\r\n        }\r\n      }\r\n      that.getUserInfo(obj2)\r\n    }\r\n  }\r\n  that.login(loginObj)\r\n}"]}